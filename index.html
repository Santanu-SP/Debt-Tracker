<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DebtTracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <meta name="theme-color" content="#4f46e5">

</head>

<body>

    <!-- AUTH VIEW -->
    <div id="auth-view" class="container" style="display: block; max-width: 400px; padding-top: 40px;">
        <header style="text-align: center; margin-bottom: 40px;">
            <h1>DebtTracker</h1>
            <p style="color: var(--text-secondary);">Track expenses & manage debts</p>
        </header>

        <!-- Login Form -->
        <div id="login-form" class="card">
            <h2>Welcome Back</h2>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="login-username" placeholder="Enter username">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="Enter password">
            </div>
            <div class="input-group">
                <div style="display: flex; align-items: center;">
                    <input type="checkbox" id="login-remember" style="width: auto; margin-right: 8px;">
                    <label for="login-remember" style="margin:0; cursor: pointer;">Remember me permanently</label>
                </div>
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Login</button>
            <p style="text-align: center; margin-top: 16px; font-size: 0.9rem;">
                New here? <a href="#" onclick="toggleAuthMode('register')" style="color: var(--primary);">Create
                    account</a>
            </p>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="card" style="display: none;">
            <h2>Create Account</h2>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="reg-username" placeholder="Choose a username">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="reg-password" placeholder="Choose a password">
            </div>
            <div class="input-group">
                <label>Confirm Password</label>
                <input type="password" id="reg-confirm-password" placeholder="Confirm password">
            </div>
            <button class="btn btn-primary" onclick="handleRegister()">Sign Up</button>
            <p style="text-align: center; margin-top: 16px; font-size: 0.9rem;">
                Already have an account? <a href="#" onclick="toggleAuthMode('login')"
                    style="color: var(--primary);">Login</a>
            </p>
        </div>
    </div>

    <!-- MAIN APP VIEW (Hidden by default) -->
    <div id="app-view" style="display: none;">
        <div class="container">
            <!-- Header -->
            <header style="display: flex; justify-content: space-between; align-items: center;">
                <h1>DebtTracker</h1>
                <div style="display:flex; gap:12px;">
                    <button class="btn"
                        style="width: auto; padding: 8px; border-radius:50%; width:40px; height:40px; background:var(--card-bg); color:var(--text-primary); box-shadow:var(--shadow-sm); border:1px solid var(--border-color);"
                        onclick="toggleTheme()" id="theme-toggle">
                        <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" style="display:none;">
                            <circle cx="12" cy="12" r="5" />
                            <path d="M12 1v2" />
                            <path d="M12 21v2" />
                            <path d="M4.22 4.22l1.42 1.42" />
                            <path d="M18.36 18.36l1.42 1.42" />
                            <path d="M1 12h2" />
                            <path d="M21 12h2" />
                            <path d="M4.22 19.78l1.42-1.42" />
                            <path d="M18.36 5.64l1.42-1.42" />
                        </svg>
                        <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                        </svg>
                    </button>
                    <button class="btn" style="width: auto; padding: 6px 12px; font-size: 0.8rem; margin:0;"
                        onclick="handleLogout()">Logout</button>
                </div>
            </header>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="view active">
                <div class="card balance-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <div>
                            <div class="label">Total Balance</div>
                            <div class="amount" id="total-balance">₹0.00</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="label" style="font-size:0.75rem;">Friends Owe You</div>
                            <div style="font-size:1.2rem; font-weight:700;" id="dashboard-owed">₹0.00</div>
                        </div>
                    </div>
                    <div
                        style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.2); font-size:0.85rem; opacity:0.9;">
                        In Bank: <span id="bank-balance" style="font-weight:600;">₹0.00</span>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-action-grid">
                    <div class="quick-action" onclick="showTransactionModal('expense')">
                        <div class="quick-action-icon" style="background: #fee2e2; color: #ef4444;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" />
                                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5" />
                                <path d="M18 12a2 2 0 0 0 0 4h4v-4Z" />
                            </svg>
                        </div>
                        <span style="font-size: 0.8rem; font-weight: 600;">Expense</span>
                    </div>
                    <div class="quick-action" onclick="showTransactionModal('lend')">
                        <div class="quick-action-icon" style="background: #e0e7ff; color: #4f46e5;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                        </div>
                        <span style="font-size: 0.8rem; font-weight: 600;">Lend</span>
                    </div>
                    <div class="quick-action" onclick="showTransactionModal('repayment')">
                        <div class="quick-action-icon" style="background: #d1fae5; color: #10b981;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="9 14 4 9 9 4" />
                                <path d="M20 20v-7a4 4 0 0 0-4-4H4" />
                            </svg>
                        </div>
                        <span style="font-size: 0.8rem; font-weight: 600;">Repay</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Recent Activity</h2>
                    <ul class="transaction-list" id="recent-transactions">
                        <li class="list-item" style="color: var(--text-secondary); justify-content: center;">No
                            transactions
                            yet</li>
                    </ul>
                    <button class="btn"
                        style="margin-top: 16px; background: var(--bg-secondary); color: var(--text-primary);"
                        onclick="showHistoryView()">View All History</button>
                </div>
            </div>

            <!-- HISTORY VIEW -->
            <div id="view-history" class="view">
                <header style="display: flex; align-items: center; margin-bottom: 20px;">
                    <button
                        onclick="switchView('view-dashboard', document.querySelector('.nav-item[data-target=\'view-dashboard\']'))"
                        style="background:none; border:none; font-size:1.5rem; margin-right:10px; cursor:pointer;">←</button>
                    <h2 style="margin:0;">History</h2>
                </header>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <select id="history-filter" onchange="renderHistoryView()"
                            style="padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <option value="1year">Last 1 Year</option>
                            <option value="all">All Time</option>
                            <option value="30days">Last 30 Days</option>
                        </select>
                        <button class="btn btn-primary" style="width: auto; padding: 8px 16px;"
                            onclick="exportHistoryToCSV()">Export CSV</button>
                    </div>
                    <ul class="transaction-list" id="history-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>

            <!-- REPORTS VIEW -->
            <div id="view-reports" class="view">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="margin:0;">Reports</h2>
                        <select id="reports-filter" onchange="renderReports()" style="width:auto; padding:8px;">
                            <option value="this_month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div style="text-align:center; margin-bottom:20px; color:var(--text-secondary); font-size:0.9rem;"
                        id="reports-date-display">
                        <!-- Date Range -->
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Income</div>
                            <div class="stat-value text-success" id="report-income">₹0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Expense</div>
                            <div class="stat-value text-danger" id="report-expense">₹0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Savings</div>
                            <div class="stat-value" id="report-savings">₹0.00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Cash Flow</h2>
                    <div id="bar-chart-container"
                        style="height:150px; display:flex; gap:20px; justify-content:center; align-items:flex-end; padding-bottom:10px;">
                        <!-- Bars injected by JS -->
                    </div>
                </div>

                <div class="card">
                    <h2>Spending by Category</h2>
                    <div style="display:flex; justify-content:center; align-items:center; gap:24px; flex-wrap:wrap;">
                        <div id="category-donut" class="donut-chart"></div>
                        <div id="category-legend" style="font-size:0.85rem;"></div>
                    </div>
                </div>
            </div>

            <!-- FRIENDS/DEBT VIEW -->
            <div id="view-friends" class="view">
                <div class="card">
                    <h2>Owed to Me</h2>
                    <div style="margin-bottom: 16px;">
                        <span style="font-size: 2rem; font-weight: 700; color: var(--success);"
                            id="total-owed">₹0.00</span>
                    </div>
                    <ul class="friend-list" id="friends-list">
                        <!-- Dynamic List -->
                    </ul>
                    <button class="btn btn-primary" onclick="showAddFriendModal()">+ Add New Friend</button>
                </div>
            </div>

            <!-- SETTINGS/SALARY VIEW -->
            <div id="view-settings" class="view">
                <div class="card">
                    <h2>Salary Settings</h2>
                    <div class="input-group">
                        <label>Monthly Salary</label>
                        <input type="number" id="salary-input" placeholder="0.00">
                    </div>
                    <!-- Salary Date Selection -->
                    <div class="input-group">
                        <label>Salary Date (Day of Month)</label>
                        <select id="salary-date">
                            <!-- Options 1-31 generated by JS -->
                        </select>
                    </div>
                    <button class="btn btn-primary" id="save-salary-btn">Save Salary Config</button>
                </div>
                <div class="card">
                    <h2>Data</h2>
                    <button class="btn btn-danger" onclick="clearAllData()">Reset User Data</button>
                </div>
            </div>
        </div>

        <!-- Floating Action Button for Transactions -->
        <button class="fab" id="add-transaction-btn" onclick="showTransactionModal()">+</button>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-target="view-dashboard"
                onclick="switchView('view-dashboard', this)">
                <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg></span>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" data-target="view-friends" onclick="switchView('view-friends', this)">
                <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg></span>
                <span>Friends</span>
            </a>
            <a href="#" class="nav-item" data-target="view-reports" onclick="switchView('view-reports', this)">
                <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                    </svg></span>
                <span>Reports</span>
            </a>
            <a href="#" class="nav-item" data-target="view-settings" onclick="switchView('view-settings', this)">
                <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg></span>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <!-- MODALS (Hidden by default) -->
    <!-- Add Transaction Modal -->
    <div id="modal-transaction" class="modal-overlay">
        <div class="modal-content">
            <h2>New Transaction</h2>
            <div class="input-group">
                <label>Description</label>
                <input type="text" id="t-desc" placeholder="e.g. Lunch">
            </div>
            <div class="input-group">
                <label>Amount</label>
                <input type="number" id="t-amount" placeholder="0.00">
            </div>
            <div class="input-group">
                <label>Type</label>
                <select id="t-type">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                    <option value="lend">Lend to Friend</option>
                    <option value="repayment">Friend Repayment</option>
                    <option value="split">Split Bill</option>
                </select>
            </div>
            <div class="input-group" id="friend-selector-group" style="display:none;">
                <label>Select Friend</label>
                <select id="t-friend-select">
                    <!-- Populated by JS -->
                </select>
            </div>

            <!-- Split UI -->
            <div class="input-group" id="split-selector-group" style="display:none;">
                <label style="margin-bottom:8px; display:block;">Select Participants</label>
                <div
                    style="border:1px solid #e5e7eb; padding:8px; border-radius:12px; max-height:150px; overflow-y:auto;">
                    <div
                        style="display:flex; align-items:center; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:4px;">
                        <input type="checkbox" id="split-include-me" checked style="width:20px; margin-right:8px;">
                        <label for="split-include-me" style="margin:0; font-weight:600;">Me (Payer)</label>
                    </div>
                    <div id="split-friends-list">
                        <!-- Checkboxes populated by JS -->
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn" style="background:#e5e7eb; color:#333;" onclick="closeModals()">Cancel</button>
                <button class="btn"
                    style="background:var(--bg-secondary); color:var(--text-primary); white-space:nowrap;"
                    onclick="addTransaction(true)">Save & Add Another</button>
                <button class="btn btn-primary" onclick="addTransaction()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="modal-friend" class="modal-overlay modal-center">
        <div class="modal-content">
            <h2>Add Friend</h2>
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="f-name" placeholder="Name">
            </div>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn" style="background:#e5e7eb; color:#333;" onclick="closeModals()">Cancel</button>
                <button class="btn btn-primary" onclick="addFriend()">Add</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Inline UI logic to avoid FOUC or simple interactions before app.js loads
        function switchView(viewId, navEl) {
            // Hide all views
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            // Show target view
            document.getElementById(viewId).classList.add('active');

            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navEl.classList.add('active');

            // Toggle FAB visibility (only on dashboard)
            const fab = document.getElementById('add-transaction-btn');
            if (viewId === 'view-dashboard') fab.style.display = 'flex';
            else fab.style.display = 'none';
        }

        function closeModals() {
            document.getElementById('modal-transaction').style.display = 'none';
            document.getElementById('modal-friend').style.display = 'none';
        }

        function showTransactionModal(preSelectedType) {
            const modal = document.getElementById('modal-transaction');
            modal.style.display = 'flex';

            const typeSelect = document.getElementById('t-type');
            if (preSelectedType) {
                typeSelect.value = preSelectedType;
            }

            // Define handler (named so we can remove it if needed, though simpler here to just overwrite or exist)
            function handleTypeChange() {
                const val = typeSelect.value;
                document.getElementById('friend-selector-group').style.display = (val === 'lend' || val === 'repayment') ? 'block' : 'none';
                document.getElementById('split-selector-group').style.display = (val === 'split') ? 'block' : 'none';

                if (val === 'split') {
                    // Trigger custom event for app.js to populate list if needed
                    // For now, simpler: we assume app.js populated it or we modify app.js to populate on load
                    // Let's just trigger a global refresh if it exists
                    if (typeof refreshSplitList === 'function') refreshSplitList();
                }
            }

            // Remove old listeners? Hard with anonymous functions. 
            // Better: just set onchange property to avoid stacking listeners
            typeSelect.onchange = handleTypeChange;

            // Initial State
            handleTypeChange();
        }

        function showAddFriendModal() {
            document.getElementById('modal-friend').style.display = 'flex';
        }
    </script>
</body>

</html>